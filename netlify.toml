# Settings in the [build] context are global and are applied to all contexts unless otherwise overridden by more specific contexts.
[build]
  command = 'jekyll build'
  publish = "_site/"

[build.environment]
  RUBY_VERSION = "2.5.4"
  RELEASE_VERSION = "v3.14"

[context.production]
  command = '''
  make bin/helm
  export PATH=$PATH:$(pwd)/bin

  jekyll build --config _config.yml,$(pwd)/netlify/_config_latest.yml --destination _site

  mv _site/sitemap.xml _site/release-legacy-sitemap.xml
  mv _site/sitemap.xml _site/latest-sitemap.xml
  mv netlify/sitemap-index.xml _site/sitemap.xml
  mv netlify/_redirects _site/_redirects

  '''

# Deploys branches specified in netlify UI as seperate individual sites (all release branches)
# Each branch is expected to have baseurl set as /archive/<version> in the _config.yml
#  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml,$(pwd)/netlify/_manifests_only.yml /

[context.branch-deploy]
  command = '''
  make bin/helm
  export PATH=$PATH:$(pwd)/bin
  # build for website
  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml --destination _site
  # build for manifests, override base url from config to version
  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml,$(pwd)/netlify/_manifests_only.yml --baseurl /$RELEASE_VERSION --destination _site/$RELEASE_VERSION
  '''

[context.deploy-preview]
  command = '''
  make bin/helm
  export PATH=$PATH:$(pwd)/bin
  echo "url: $DEPLOY_PRIME_URL" > _config_url.yml
  jekyll build --config _config.yml,_config_url.yml
  '''

# Deploys master branch as a seperate individual sites (all release branches)
# Master is to have baseurl set as /master in the _config.yml
[context.master]
  command = '''
  make bin/helm
  export PATH=$PATH:$(pwd)/bin
  # build for website
  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml
  '''

#should not contain any baseurl in _config.yml
[context.release-legacy]
  command = '''
  make bin/helm
  export PATH=$PATH:$(pwd)/bin
  # build for website
  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml --baseurl /archive
  # build for manifests, override base url from config to version
  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml,$(pwd)/netlify/_manifests_only.yml
  '''

[[redirects]]
  from = "/archive/v3.14/*"
  to = "https://release-v3-14--calico-test.netlify.app/archive/v3.14/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/master/*"
  to = "https://master--calico-test.netlify.app/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.11/*"
  to = "https://release-legacy--calico-test.netlify.app/v3.11/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.10/*"
  to = "https://release-legacy--calico-test.netlify.app/v3.10/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

[[headers]]
  for = "/*.yaml"
  [headers.values]
    content-type = "text/yaml"

[[headers]]
  for = "/*.yml"
  [headers.values]
    content-type = "text/yaml"

[[headers]]
  for = "/*.sh"
  [headers.values]
    content-type = "text/x-shellscript"

[[headers]]
  for = "/*.bash"
  [headers.values]
    content-type = "text/x-shellscript"
