# Settings in the [build] context are global and are applied to all contexts unless otherwise overridden by more specific contexts.
# The cp, bundle install and bundle exec parts are only required to work around not being able to put the Gemfile int he root directory. It can't go in the root because that breaks the jekyll/jekyll container.
[build]
  command = 'jekyll build'

[build.environment]
  RUBY_VERSION = "2.5.4"
  CUSTOM_ARCHIVE_PATH = "/archive"

[context.production]
  command = '''
  make bin/helm
  export PATH=$PATH:$(pwd)/bin
  jekyll build --config _config.yml
  mv _site/sitemap.xml _site/release-legacy-sitemap.xml
  mv _site/sitemap.xml _site/latest-sitemap.xml
  mv netlify/sitemap-index.xml _site/sitemap.xml
  mv netlify/_redirects _site/_redirects
  '''

[context.branch-deploy]
  command = '''
  make bin/helm
  export PATH=$PATH:$(pwd)/bin
  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml --baseurl /archive/$RELEASE_VERSION
  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml,$(pwd)/netlify/_manifests_only.yml --baseurl /$RELEASE_VERSION --destination _site/$RELEASE_VERSION
  '''

[context.deploy-preview]
  command = '''
  make bin/helm
  export PATH=$PATH:$(pwd)/bin
  echo "url: $DEPLOY_PRIME_URL" > _config_url.yml
  jekyll build --config _config.yml,_config_url.yml --baseurl /
  '''

[context.release-legacy]
  command = '''
  make bin/helm
  export PATH=$PATH:$(pwd)/bin
  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml --baseurl /archive
  jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml,$(pwd)/netlify/_manifests_only.yml --baseurl /
  '''

[[redirects]]
  from = "/v3.14/*"
  to = "https://release-v3-14--calico-test.netlify.app/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/master/*"
  to = "https://master--calico-test.netlify.app/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.11/*"
  to = "https://release-legacy--calico-test.netlify.app/v3.11/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.10/*"
  to = "https://release-legacy--calico-test.netlify.app/v3.10/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

[[headers]]
  for = "/*.yaml"
  [headers.values]
    content-type = "text/yaml"

[[headers]]
  for = "/*.yml"
  [headers.values]
    content-type = "text/yaml"

[[headers]]
  for = "/*.sh"
  [headers.values]
    content-type = "text/x-shellscript"

[[headers]]
  for = "/*.bash"
  [headers.values]
    content-type = "text/x-shellscript"